# syncctl

`syncctl` is a tool for packaging all the artifacts for running Flux in a air-gapped environment. It can be tested with [this](https://github.com/distributed-technologies/flux-test/) example Flux repository.

**Please note:** `syncctl` doesn't package [`GitRepository`](https://fluxcd.io/docs/components/source/gitrepositories/) specified in Flux. You are expected to run `syncctl` for every individuel repository you want in your air-gapped environment, this is done to support different release cadence in a [multi tenancy](https://github.com/fluxcd/flux2-multi-tenancy) setup.

`syncctl` requires:
* Python 3.9
* [Requests](https://pypi.org/project/requests/)
* [GitPython](https://pypi.org/project/GitPython/)
* [PyYAML](https://pyyaml.org/wiki/PyYAML)
* [kubectl](https://kubernetes.io/docs/reference/kubectl/)
* [Helm](https://helm.sh/)
* [skopeo](https://github.com/containers/skopeo)

## Config file

The config file contains the configuration used for generating the [manifest file](#manifest-file).

### `flux_repository`

The `flux_repository` section describes the flux repository to use. A `branch` or `commit` can be specified, but not both.

`flux_repository` is optional (`repository` is used if not specified) and specificies the Git URL used to check if a Flux `GitRepository` refers to the cloned repository.
This should normally only be used if the domain or URL path are different, as `syncctl` ignores the protoctol, port and basic auth credentials when comparing Git URLs.

```json
"flux_repository": {
    "branch": "main",
    "commit": "c41e80920182f4dc44f36743c57f630ce0eabc57",
    "entrypoint": "clusters/dev/flux-system",
    "flux_repository": "https://github.com/distributed-technologies/flux-test.git",
    "repository": "https://github.com/distributed-technologies/flux-test.git"
}
```

### `helm`

The `helm` section describes how the charts should be templated for finding the images.

```json
"helm": {
    "api_versions": [
        "networking.k8s.io/v1/IngressClass"
    ],
    "values": {
        "config.externalProxy": "127.0.0.1:80"
    }
}
```

| Name           | Type             | Description |
| -------------- | ---------------- | ----------- |
| `api_versions` | `list[str]`      | API versions to pass to `helm template` |
| `values`       | `dict[str, str]` | Values to pass to `helm template` |

## Manifest file

The manifest file describes the artifacts. It consists of 3 sections.

**The file is generated by the tool and shouldn't be edited manually!**

### `flux_repository`

The `flux_repository` section describes the Flux repository to package.

```json
"flux_repository": {
    "branch": "main",
    "commit": "c41e80920182f4dc44f36743c57f630ce0eabc57",
    "entrypoint": "clusters/dev/flux-system",
    "repository": "https://github.com/distributed-technologies/flux-test.git"
}
```

### `images`

The `images` section describes the images to package.

```json
"images": [
    {
        "digest": "sha256:2e0e725c9282bfb7b08bea7dbbfd8dbce6410d670e3f8addd9b6540d818ad520",
        "image": "argoproj/argocd",
        "registry": "quay.io",
        "tag": "v2.1.2"
    }
]
```

### `charts`

The `charts` section describes the charts to package.

```json
"charts": [
    {
        "chart": "rook",
        "digest": "0d9c16a988d6e0dfd6d4b02173d6334e61c122d1825c4f1467253b418a93f1c9",
        "version": "0.1.3"
    }
]
```

## Usage

`syncctl` needs a `config.json` file (see [`config.json.sample`](config.json.sample) for a example)

```sh
$ ./syncctl
usage: syncctl [-h] [-v] [-c CONFIG] [-m MANIFEST] {mirror-flux,mirror-charts,mirror-images,resolve-images,tar} ...

positional arguments:
  {mirror-flux,mirror-charts,mirror-images,resolve-images,tar}
    mirror-flux         mirror the flux git repository to the local fs
    mirror-charts       mirror the charts to the local fs
    mirror-images       mirror the container images to the local fs
    resolve-images      resolve container images to digest and update the manifest file
    tar                 create a tarball

options:
  -h, --help            show this help message and exit
  -v, --verbose         Causes to print debugging messages about the progress
  -c CONFIG, --config CONFIG
                        Specify config file to use
  -m MANIFEST, --manifest MANIFEST
                        Specify manifest file to use
```
